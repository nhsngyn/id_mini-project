<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <title>Price & Volume</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>

<body class="bg-[#2E2E34cc] text-slate-200 font-sans">
  <div class="max-w-[1920px] mx-auto p-4 bg-[#21252C]">
    <!-- 상단 바 -->
    <div class="flex flex-col gap-2 mb-3">
      <h1 class="text-lg font-semibold">Price &amp; Volume</h1>
    </div>

    <!-- 차트 패널 -->
    <div class="bg-[#0d1014] border border-[#1b1f24] rounded-xl px-3 shadow-inner">
      <!-- 드롭다운 + 오른쪽 배지 -->
      <div class="max-w-[1920px] max-h-[1080px] flex items-center justify-between">
        <!-- 왼쪽: Asset 선택 -->
        <div class="relative w-48">
          <select id="asset" class="peer appearance-none w-full bg-[#181c21] text-[#474F59] border border-[#2b323a] rounded-xl
                 px-3 pr-8 py-2 cursor-pointer text-sm shadow-sm
                 hover:border-[#3a434e] focus:outline-none focus:ring-2 focus:ring-emerald-500/40
                 focus:border-emerald-400/40">
            <option value="mantra">Mantra</option>
            <option value="bitcoin">Bitcoin</option>
            <option value="ethereum">Ethereum</option>
          </select>
          <!-- 오른쪽 화살표 아이콘 -->
          <img src="img/icn_arrow_btm.svg" alt="arrow icon" class="pointer-events-none absolute right-2.5 top-1/2 -translate-y-1/2 h-4 w-4
                      opacity-70 transition-all duration-200
                      peer-focus:opacity-100 peer-focus:scale-110" />
        </div>

        <!-- 오른쪽: 배지 영역 (interval + range) -->
        <div class="flex items-center py-2">
          <div class="bg-[#181c21]/70 border border-[#2E2E34cc] rounded-xl px-3 py-2
             shadow-[0_0_0_1px_rgba(255,255,255,0.06)_inset] backdrop-blur
             text-slate-300 text-[12px] scale-90 origin-right">
            <div class="flex items-center gap-3 mb-3">
              <img src="img/icn_candle.svg" alt="chart icon" class="h-6 w-6 opacity-70" />
              <div class="text-[13px] leading-tight">
                <span style="color:#474F59">Interval</span>
                <span class="ml-2 font-semibold" style="color:#474F59" id="badge-interval">1 Day</span>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <img src="img/icn_range.svg" alt="range icon" class="h-6 w-6 opacity-70" />
              <div class="text-[13px] leading-tight">
                <span style="color:#474F59">Range</span>
                <span class="ml-2 font-semibold" style="color:#474F59" id="badge-range">—</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 차트 -->
      <div id="chart" class="h-[600px] w-full"></div>
    </div>
  </div>

  <!-- (옵션) 인라인 JSON: 항상 [d, o, c, l, h, v] 가정 -->
  <!-- <script type="application/json" id="ohlcv">[[ "2025-10-16",0.1328,0.1356,0.1290,0.1490,124726250 ], ... ]</script> -->

  <script>
    const upColor = '#0FA76C';   // 상승색
    const downColor = '#C93C50'; // 하락색

    /* =========================
       데이터 유틸 (간소화 버전)
       ========================= */

    // 1) 인라인 JSON 읽기 (id: ohlcv)
    function readInlineJSON() {
      const el = document.getElementById('ohlcv');
      if (!el) return null;
      try {
        const txt = el.textContent.trim();
        if (!txt) return null;
        return JSON.parse(txt);
      } catch (e) {
        console.error('JSON 파싱 실패(ohlcv):', e);
        return null;
      }
    }

    // 2) 파싱: 고정 스키마 [d, o, c, l, h, v] + 오름차순 날짜를 가정
    function splitData(raw) {
      const categoryData = [], values = [], volumes = [];
      if (!Array.isArray(raw) || raw.length === 0) return { categoryData, values, volumes };

      for (let i = 0; i < raw.length; i++) {
        const r = raw[i];
        if (!r || r.length < 6) continue;

        const date = String(r[0]);
        const open = Number(r[1]);
        const close = Number(r[2]);
        const low = Number(r[3]);
        const high = Number(r[4]);
        const vol = Number(r[5]);

        categoryData.push(date);
        values.push([open, close, low, high]); // ECharts가 요구하는 순서(O C L H)
        const dir = open > close ? 1 : -1;     // 하락=1, 상승=-1 (visualMap과 맞춤)
        volumes.push([i, vol, dir]);
      }

      return { categoryData, values, volumes };
    }

    /* =========================
       차트 옵션
       ========================= */
    function buildOption(data) {
      // ★ 1일에만 라벨/틱을 찍기
      const cat = data.categoryData;    // ["YYYY/MM/DD", ...]
      const DayOfMonthIdx = new Set();
      for (let i = 0; i < cat.length; i++) {
        const [y, m, d] = String(cat[i]).split('/'); // "YYYY/MM/DD"
        if (d === '25') DayOfMonthIdx.add(i);
      }
      const MMM = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

      return {
        backgroundColor: 'transparent',
        animation: false,
        grid: [
          { left: '6%', right: '5%', top: 20, height: '58%' },
          { left: '6%', right: '5%', top: '68%', height: '22%' }
        ],


        xAxis: [{
          type: 'category',
          data: data.categoryData,
          axisPointer: {           // ✦ 세로선 스타일
            show: true,
            lineStyle: {
              color: '#8ab4f8',
              width: 5,
              type: 'shadow',      // ← 세로선은 점선
              opacity: 0.3
            },
            label: {
              show: true,
              backgroundColor: '#1f2430',
              color: '#d7e2f2',
              borderRadius: 4,
              padding: [2, 6]
            }
          },

          splitLine: { show: false },
          min: 'dataMin',
          max: 'dataMax'
        },
        {
          type: 'category',
          gridIndex: 1,
          data: data.categoryData,
          boundaryGap: true,
          axisLine: { lineStyle: { color: '#2b323a' } },
          axisTick: { show: false },
          axisLabel: { show: false },
          splitLine: { show: false },
          min: 'dataMin',
          max: 'dataMax'
        }
        ],

        yAxis: [
          {
            scale: true,
            axisLine: { show: false },
            axisTick: { show: false },
            axisLabel: { color: '#7f8ea1' },
            splitLine: { lineStyle: { color: '#1e242b', type: 'dashed' } }, //가격 기준선(그리드 라인 점선)
            splitArea: { show: false }
          },
          {
            scale: true,
            gridIndex: 1,
            axisLine: { show: false },        // 세로축 라인은 그대로 숨김
            axisTick: { show: false },
            axisLabel: {                      // ✅ 볼륨 축 라벨 표시
              show: true,
              color: '#7f8ea1',
              formatter: (v) => {
                if (v >= 1e9) return (v / 1e9).toFixed(1) + 'B';
                if (v >= 1e6) return (v / 1e6).toFixed(0) + 'M';
                if (v >= 1e3) return (v / 1e3).toFixed(0) + 'K';
                return v;
              }
            },
            splitLine: {                      // 판매량 가로 기준선(그리드 라인)
              show: true,
              lineStyle: {
                color: '#1e242b',
                type: 'dashed'
              }

            }
          }
        ],
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'cross',
            snap: true,
            lineStyle: { color: 'rgba(255,255,255,0.45)', width: 1, type: 'dashed' },
            label: {
              show: true,
              backgroundColor: 'rgba(61,66,77,0.95)',
              color: '#E6EBF2',
              borderColor: 'rgba(255,255,255,0.08)',
              borderWidth: 1,
              borderRadius: 10,
              padding: [6, 10],
              formatter: (obj) => (
                obj.axisDimension === 'x'
                  ? String(obj.value ?? '')           // ← X축(날짜) 배지 텍스트
                  : (Number.isFinite(+obj.value) ? (+obj.value).toFixed(3) : obj.value)  // ← Y축(가격) 배지 텍스트
              )
            }
          },
          backgroundColor: 'rgba(46,46,52,0.1)', // ← 진짜 글라스는 투명 배경 + 내부 스타일
          borderWidth: 0,
          padding: 0,
          formatter: function (params) {
            const k = params.find(p => p.seriesType === 'candlestick');
            if (!k) return '';
            const [date, open, close, low, high] = k.data.map(Number);
            const isUp = close >= open;
            const valColor = isUp ? '#4FF68C' : '#FF3B52';
            const fmt = v => (Number.isFinite(v) ? v.toFixed(3) : '-');

            const label = k.axisValueLabel || k.name || '';
            const [dateStr, t] = String(label).split(/[ T]/);
            const timeStr = t ? t.slice(0, 5) : '09:00';

            return `
<div style="
  min-width:220px;
  padding:16px;
  border-radius:12px;
  background: rgba(24,28,33,0.01);
  border: 1px solid rgba(255,255,255,0);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  color:#E6EBF2;
  box-shadow: 0 10px 30px rgba(0,0,0,0.35);
">
  <div style="display:flex;justify-content:space-between;margin-bottom:8px;color:#A3AEC2;font-size:12px;font-weight:600">
    <span>${dateStr || ''}</span><span>${timeStr}</span>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;row-gap:6px;font-size:13px;">
    <span>OPEN</span><span style="text-align:right;color:${valColor}">${fmt(open)}</span>
    <span>HIGH</span><span style="text-align:right;color:${valColor}">${fmt(high)}</span>
    <span>LOW</span><span style="text-align:right;color:${valColor}">${fmt(low)}</span>
    <span>CLOSE</span><span style="text-align:right;color:${valColor}">${fmt(close)}</span>
  </div>
</div>`;
          }
        },
        dataZoom: [
          { type: 'inside', xAxisIndex: [0, 1], start: 40, end: 100 },
          {
            type: 'slider', xAxisIndex: [0, 1], top: '93%', height: 16,
            brushSelect: false, handleSize: '80%', borderColor: '#1f2a37',
            backgroundColor: '#111418',
            dataBackground: { lineStyle: { color: '#273341' }, areaStyle: { color: '#17202a' } },
            fillerColor: 'rgba(83,120,175,0.25)', textStyle: { color: '#7b8ea3' }
          }
        ],
        visualMap: {
          show: false,
          seriesIndex: 1,
          dimension: 2, // volumes: [i, volume, dir]
          pieces: [
            { value: 1, color: downColor }, // 1 → 하락(빨강)
            { value: -1, color: upColor }   // -1 → 상승(초록)
          ]
        },
        series: [
          {
            name: 'Price',
            type: 'candlestick',
            data: data.values,
            itemStyle: {
              color: upColor,
              color0: downColor,
              borderColor: upColor,
              borderColor0: downColor
            }
          },
          {
            name: 'Volume',
            type: 'bar',
            xAxisIndex: 1,
            yAxisIndex: 1,
            data: data.volumes,
            barWidth: '60%',
            itemStyle: { opacity: 0.85 },
            markLine: {                       // ✅ 0 기준선
              symbol: 'none',
              label: { show: false },
              lineStyle: { color: '#334155', width: 1 },
              data: [{ yAxis: 0 }]
            }
          }
        ]
      };
    }

    // 배지 업데이트
    function updateBadges(categoryData) {
      const fmt = (ds) => {
        const [y, m, d] = String(ds).split('-');
        return m && d ? `${m}/${d}` : ds;
      };
      const days = categoryData.length; //days data.length - 1;
      const first = categoryData[0];
      const last = categoryData[days - 1];
      document.getElementById('badge-interval').textContent = '1 Day';
      document.getElementById('badge-range').textContent =
        days ? `${days} Days (${fmt(first)}–${fmt(last)})` : '—';
    }

    // fetch 유틸
    async function loadJSON(url) {
      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (e) {
        console.warn('fetch 실패:', url, e);
        return null;
      }
    }

    // 차트 초기화
    const chart = echarts.init(document.getElementById('chart'), null, { renderer: 'canvas' });

    // 부트스트랩: 데이터 주입 경로
    async function boot(preferredFile) {
      let raw = readInlineJSON();                                      // 1) inline (#ohlcv)
      if (!raw && Array.isArray(window.rawData)) raw = window.rawData; // 2) 전역
      if (!raw) {                                                      // 3) 파일
        const candidate = preferredFile || 'mantra_60days.json';
        raw = await loadJSON(candidate);
      }

      if (!raw || !Array.isArray(raw) || raw.length === 0) {
        const toast = document.createElement('div');
        toast.textContent = '데이터가 없습니다. window.rawData, #ohlcv, 또는 JSON 파일(mantra_60days.json)을 주입하세요.';
        toast.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-md bg-red-500/90 text-white text-sm shadow';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
        return;
      }

      const parsed = splitData(raw);           // ★ 고정 스키마(O C L H V) 가정
      chart.setOption(buildOption(parsed), true);
      updateBadges(parsed.categoryData);


      // ✅ 캔들 폭에 맞춰 세로 axisPointer 두께 자동 동기화
      chart.off('updateAxisPointer');
      chart.on('updateAxisPointer', function () {
        const xAxisModel = chart.getModel().getComponent('xAxis', 0);
        if (!xAxisModel) return;
        const extentIdx = xAxisModel.axis.scale.getExtent();  // 데이터 인덱스 범위 [min,max]
        const extentPx = xAxisModel.axis.getExtent();        // 픽셀 범위 [pxStart,pxEnd]
        const pixelW = Math.abs(extentPx[1] - extentPx[0]);
        const count = Math.max(1, extentIdx[1] - extentIdx[0]);
        const barW = pixelW / count;

        chart.setOption({
          xAxis: [{ axisPointer: { lineStyle: { width: barW } } }]
        }, false);
      });

      // (옵션) 마우스 아웃 시 price 패널 고정선 제거
      chart.getZr().off('mouseout');
      chart.getZr().on('mouseout', () => {
        chart.setOption({ series: [{ id: 'price', markLine: { data: [] } }] }, false);
      });
    }

    // 드롭다운으로 파일 전환
    document.getElementById('asset').addEventListener('change', async (e) => {
      const asset = e.target.value; // 'mantra' | 'bitcoin' | 'ethereum'
      await boot(`${asset}_60days.json`);
    });

    // 최초 실행 (기본: mantra_60days.json)
    boot();

    window.addEventListener('resize', () => chart.resize());
  </script>
</body>

</html>